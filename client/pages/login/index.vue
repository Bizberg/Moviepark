<template>
  <div class="relative flex items-center justify-center min-h-screen px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-md -mt-14">
      <div>
        <svg class="w-auto mx-auto h-11 sm:h-15 md:h-17" viewBox="0 0 1024 205" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M239.086 163.963C275.667 163.963 297.324 140.546 297.324 106.006C297.324 71.4664 275.667 48.0494 239.086 48.0494C202.504 48.0494 180.849 71.4664 180.849 106.006C180.849 140.546 202.504 163.963 239.086 163.963ZM239.379 134.106C228.551 134.106 222.113 123.349 222.113 105.714C222.113 88.0777 228.551 77.3206 239.379 77.3206C249.622 77.3206 256.06 88.0777 256.06 105.714C256.06 123.349 249.622 134.106 239.379 134.106ZM415.308 49.5129H372.874L354.729 123.862H353.559L335.414 49.5129H292.979L330.731 161.914H377.555L415.308 49.5129ZM418.553 161.914H458.939V49.5129H418.553V161.914ZM438.747 37.8045C449.721 37.8045 458.647 29.5354 458.647 19.3637C458.647 9.19194 449.721 0.922852 438.747 0.922852C427.771 0.922852 418.846 9.19194 418.846 19.3637C418.846 29.5354 427.771 37.8045 438.747 37.8045ZM525.124 163.963C556.291 163.963 576.337 149.035 580.142 125.617H543.269C540.926 131.984 534.269 135.57 526.002 135.57C514.003 135.57 506.979 127.667 506.979 116.837V115.081H580.142V105.714C580.142 69.9296 558.194 48.0494 524.245 48.0494C489.419 48.0494 467.178 71.1736 467.178 106.006C467.178 142.376 489.128 163.963 525.124 163.963ZM506.979 92.8343C507.199 83.1016 515.247 76.4424 525.124 76.4424C535.148 76.4424 542.756 83.1749 542.975 92.8343H506.979ZM588.381 204.065H628.767V143.474H629.352C634.035 154.889 644.863 163.378 660.667 163.378C684.664 163.378 704.857 144.645 704.857 105.714C704.857 65.0268 683.201 48.0494 660.959 48.0494C644.278 48.0494 633.743 57.7089 629.352 69.1247H628.475V49.5129H588.381V204.065ZM627.89 105.714C627.89 89.0291 634.62 79.0768 645.742 79.0768C656.863 79.0768 663.301 89.0291 663.301 105.714C663.301 122.398 656.863 132.35 645.742 132.35C634.62 132.35 627.89 122.106 627.89 105.714ZM744.85 163.67C759.482 163.67 770.53 158.694 777.333 146.108H778.212V161.914H815.963V84.931C815.963 64.1485 796.283 48.0494 764.165 48.0494C730.582 48.0494 714.047 65.612 712.658 86.1019H749.824C750.776 79.1501 755.896 75.857 763.579 75.857C770.603 75.857 775.578 79.0768 775.578 84.931V85.2238C775.578 91.7366 768.408 93.7855 749.531 95.1759C726.338 96.8591 708.268 106.226 708.268 130.887C708.268 153.279 723.34 163.67 744.85 163.67ZM758.018 138.205C751.14 138.205 746.312 134.839 746.312 128.545C746.312 122.764 750.409 118.301 759.775 116.837C766.213 115.812 771.627 114.495 775.871 112.738V122.106C775.871 132.35 767.163 138.205 758.018 138.205ZM827.019 161.914H867.406V103.372C867.406 90.4926 876.258 82.004 888.183 82.004C892.354 82.004 899.086 82.6625 903.109 84.0529V49.5862C899.89 48.6348 896.379 48.0494 892.866 48.0494C880.868 48.0494 871.502 55.0745 867.406 70.881H866.236V49.5129H827.019V161.914ZM908.111 161.914H948.496V130.009L954.57 122.325L977.469 161.914H1023.71L984.347 98.7617L1022.54 49.5129H977.177L949.96 87.2728H948.496V12.0459H908.111V161.914Z" fill="#DAD6D6" />
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0.657471 12.0449V161.913H40.4583V74.6853H41.6289L74.9913 160.743H98.9889L132.351 75.2706H133.522V161.913H173.323V12.0449H122.694L87.868 96.9313H86.1122L51.2865 12.0449H0.657471ZM26.7685 24.5342H12.4616C10.8812 24.5342 9.6001 25.8156 9.6001 27.3962V43.6927C9.6001 45.2734 10.8812 46.5548 12.4616 46.5548H26.7685C28.3489 46.5548 29.63 45.2734 29.63 43.6927V27.3962C29.63 25.8156 28.3489 24.5342 26.7685 24.5342ZM12.4611 59.5078H26.768C28.3484 59.5078 29.6295 60.7892 29.6295 62.3699V78.6664C29.6295 80.247 28.3484 81.5284 26.768 81.5284H12.4611C10.8807 81.5284 9.59961 80.247 9.59961 78.6664V62.3699C9.59961 60.7892 10.8807 59.5078 12.4611 59.5078ZM26.768 94.4814H12.4611C10.8807 94.4814 9.59961 95.7628 9.59961 97.3435V113.64C9.59961 115.221 10.8807 116.502 12.4611 116.502H26.768C28.3484 116.502 29.6295 115.221 29.6295 113.64V97.3435C29.6295 95.7628 28.3484 94.4814 26.768 94.4814ZM12.4611 129.457H26.768C28.3484 129.457 29.6295 130.738 29.6295 132.319V148.616C29.6295 150.196 28.3484 151.478 26.768 151.478H12.4611C10.8807 151.478 9.59961 150.196 9.59961 148.616V132.319C9.59961 130.738 10.8807 129.457 12.4611 129.457ZM161.258 24.5342H146.952C145.371 24.5342 144.09 25.8156 144.09 27.3962V43.6927C144.09 45.2734 145.371 46.5548 146.952 46.5548H161.258C162.839 46.5548 164.12 45.2734 164.12 43.6927V27.3962C164.12 25.8156 162.839 24.5342 161.258 24.5342ZM146.952 59.5078H161.258C162.839 59.5078 164.12 60.7892 164.12 62.3699V78.6664C164.12 80.247 162.839 81.5284 161.258 81.5284H146.952C145.371 81.5284 144.09 80.247 144.09 78.6664V62.3699C144.09 60.7892 145.371 59.5078 146.952 59.5078ZM161.258 94.4814H146.952C145.371 94.4814 144.09 95.7628 144.09 97.3435V113.64C144.09 115.221 145.371 116.502 146.952 116.502H161.258C162.839 116.502 164.12 115.221 164.12 113.64V97.3435C164.12 95.7628 162.839 94.4814 161.258 94.4814ZM146.952 129.457H161.258C162.839 129.457 164.12 130.738 164.12 132.319V148.616C164.12 150.196 162.839 151.478 161.258 151.478H146.952C145.371 151.478 144.09 150.196 144.09 148.616V132.319C144.09 130.738 145.371 129.457 146.952 129.457Z" fill="#D70745" />
        </svg>
        <h2 class="mt-6 text-2xl font-extrabold leading-9 text-center text-gray-300 sm:text-3xl">
          Log in to your account
        </h2>
        <p class="mt-2 text-sm leading-5 text-center text-gray-300">
          Or
          <nuxt-link to="/Register" class="font-medium transition duration-150 ease-in-out text-m-burgundy-600 hover:text-m-burgundy-700 focus:outline-none focus:underline">
            Register for free!
          </nuxt-link>
        </p>
      </div>
      <ValidationObserver ref="form" v-slot="{ handleSubmit, errors, invalid}">
        <form @submit.prevent class="mt-8">
          <input type="hidden" name="remember" value="true" />
          <div class="rounded-md shadow-sm">
            <div>
              <ValidationProvider
                v-slot="{ validated, failed }"
                vid="username"
                name="username"
                mode="eager"
                rules="required|alpha_dash"
              >
                <input v-model="login.username" aria-label="Username" name="username" type="username" required
                       :class="validated && failed ? 'text-red-400' : 'text-gray-300'"
                       class="relative block w-full px-3 py-2 text-gray-300 placeholder-gray-400 border border-transparent rounded-none appearance-none bg-m-blue-900 rounded-t-md focus:outline-none focus:border-teal-700 focus:z-10 sm:text-sm sm:leading-5" placeholder="Username"
                />
              </ValidationProvider>
            </div>
            <div class="-mt-px">
              <ValidationProvider
                v-slot="{ validated, failed }"
                vid="password"
                name="password"
                mode="eager"
                rules="required"
              >
                <input v-model="login.password" aria-label="Password" name="password" type="password" required
                       :class="validated && failed ? 'text-red-400' : 'text-gray-300'"
                       class="relative block w-full px-3 py-2 text-gray-300 placeholder-gray-400 border border-transparent rounded-none appearance-none bg-m-blue-900 rounded-b-md focus:outline-none focus:border-teal-700 focus:z-10 sm:text-sm sm:leading-5" placeholder="Password"
                />
              </ValidationProvider>
            </div>
          </div>

          <div class="flex items-center justify-center mt-6">
            <div class="flex items-center">

              <input v-model="login.remember_me" id="remember_me" type="checkbox"
                     class="w-4 h-4 transition duration-150 ease-in-out border-transparent cursor-pointer bg-m-blue-900 text-m-burgundy-600 form-checkbox focus:outline-none focus:bg-m-burgundy-800 active:bg-m-burgundy-800 focus:shadow-none focus:border-teal-700"
              />

              <label for="remember_me" class="block ml-2 text-sm leading-5 text-gray-300 cursor-pointer">
                Remember me
              </label>
            </div>
          </div>

          <div class="mt-6">
            <button @click="handleSubmit(userLogin)" :disabled="invalid" type="submit" class="relative flex justify-center w-full px-4 py-2 text-sm font-medium leading-5 text-white transition duration-150 ease-in-out border border-transparent rounded-md bg-m-burgundy-600 group hover:bg-m-burgundy-700 focus:outline-none focus:bg-m-burgundy-800 active:bg-m-burgundy-800 ">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                <svg class="w-5 h-5 text-white transition duration-150 ease-in-out group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                </svg>
              </span>
              Log in
            </button>
          </div>

          <div>
            <div v-if="errors.username" class="mt-6 text-sm italic leading-4">
              <div v-if="errors.username[0] !== undefined" class="flex items-center px-4 py-3 bg-red-400 rounded-md font-sm text-m-blue-900">
                <svg-icon name="alertCircle" class="w-4 h-4 mr-2 text-m-blue-900" />
                <div>
                  {{ errors.username[0] !== undefined ? 'Username: ' + errors.username[0] : '' }}
                </div>
              </div>
            </div>
            <p v-if="errors.password" class="mt-3 text-sm italic leading-4 text-red-400">{{ errors.password[0] !== undefined ? '• Password: ' + errors.password[0] : '' }}</p>
            <p v-if="errorLogin" class="mt-3 text-sm italic leading-4 text-red-400">• Wrong Credentials</p>
          </div>
        </form>
      </ValidationObserver>
    </div>
  </div>
</template>

<script>
import { ValidationProvider, ValidationObserver } from 'vee-validate'

export default {
  middleware: 'auth',
  auth: 'guest',
  components: {
    ValidationProvider,
    ValidationObserver
  },
  data () {
    return {
      login: {
        username: '',
        password: '',
        remember_me: false
      },
      errorLogin: false
    }
  },
  methods: {
    async userLogin () {
      try {
        await this.$auth.loginWith('local', { data: this.login })
      } catch (err) {
        console.log(err.response.data)
        if (err.response.data.errors[0].message === 'Invalid user credentials') {
          this.errorLogin = true
        } else {
          const payload = err.response.data.errors.reduce((acc, curr) => ({ ...acc, [curr.field]: [curr.message] }), {})
          this.$refs.form.setErrors(payload)
        }
      }
    }
  },
  head () {
    return {
      title: 'Login'
    }
  }
}
</script>
